<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #e0f2fe 0, #f8fafc 45%, #e5e7eb 100%);
      min-height: 100vh;
    }
    .navbar { border-bottom: 1px solid rgba(0,0,0,0.05); }
    .card { border-radius: 1rem; }
    .card-shadow { box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08); }
    .btn-health, .btn-fan { border-radius: 999px; }
    .nav-tabs .nav-link { cursor: pointer; }
  </style>
</head>
<body>
<nav class="navbar navbar-light bg-white shadow-sm px-3">
  <span class="navbar-brand fw-semibold">My Dashboard</span>
  <span class="ms-auto">
    Welcome, {{ user }} |
    <a href="{{ url_for('logout') }}" class="text-decoration-none">Logout</a>
  </span>
</nav>

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Sensor Data</h3>
    <div>
      <button class="btn btn-primary btn-fan me-2" id="fanOn">Ventilator ON</button>
      <button class="btn btn-secondary btn-fan" id="fanOff">Ventilator OFF</button>
      <a href="{{ url_for('health_dashboard') }}" class="btn btn-outline-success btn-sm btn-health ms-2">
        üîç Service Health
      </a>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="dataTabs">
    <li class="nav-item"><span class="nav-link active" onclick="updateChart('temperature')">Temperature</span></li>
    <li class="nav-item"><span class="nav-link" onclick="updateChart('pressure')">Pressure</span></li>
    <li class="nav-item"><span class="nav-link" onclick="updateChart('airflow')">Airflow</span></li>
  </ul>

  <div class="card card-shadow">
    <div class="card-body">
      <canvas id="myChart" height="100"></canvas>
    </div>
  </div>
</div>

<script>
  // Gem alle data fra backend
  const allData = {{ data|tojson }};

  // Formater labels som dd-mm-yyyy HH:MM
  const labels = allData.map(row => {
      const d = new Date(row.timestamp);
      const day = String(d.getDate()).padStart(2,'0');
      const month = String(d.getMonth()+1).padStart(2,'0');
      const year = d.getFullYear();
      const hour = String(d.getHours()).padStart(2,'0');
      const minute = String(d.getMinutes()).padStart(2,'0');
      return `${day}-${month}-${year} ${hour}:${minute}`;
  });

  // Start grafen med Temperature som standard
  const ctx = document.getElementById('myChart');
  const myChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: labels,
          datasets: [{
              label: 'Temperature',
              data: allData.map(row => row.temperature),
              borderWidth: 2,
              fill: true,
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              tension: 0.3,
              pointRadius: 3
          }]
      },
      options: {
          plugins: { legend: { display: false } },
          scales: {
              x: { grid: { display: false } },
              y: { grid: { color: 'rgba(148,163,184,0.3)' } }
          }
      }
  });

  function updateChart(field) {
      myChart.data.datasets[0].data = allData.map(row => row[field]);
      myChart.data.datasets[0].label = field.charAt(0).toUpperCase() + field.slice(1);
      myChart.update();

      document.querySelectorAll('#dataTabs .nav-link').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
  }

  // Ventilator knapper
  document.getElementById('fanOn').addEventListener('click', async () => {
      await fetch('/fan/start', {method: 'POST'});
      alert('Ventilator t√¶ndt');
  });
  document.getElementById('fanOff').addEventListener('click', async () => {
      await fetch('/fan/stop', {method: 'POST'});
      alert('Ventilator slukket');
  });
</script>
</body>
</html>